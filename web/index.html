<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Letter Boxed Solver</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .game-input {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .letter-box-container {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            position: relative;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            padding: 20px;
        }

        .letter-field {
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: clamp(16px, 3vw, 32px);
            font-weight: bold;
            text-transform: uppercase;
            border: 2px solid #333;
            border-radius: 4px;
            background: white;
            padding: 0;
        }

        .letter-field:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Top side - char00, char01, char02 (left to right) */
        #char00 { grid-column: 2; grid-row: 1; }
        #char01 { grid-column: 3; grid-row: 1; }
        #char02 { grid-column: 4; grid-row: 1; }

        /* Right side - char03, char04, char05 (top to bottom) */
        #char03 { grid-column: 5; grid-row: 2; }
        #char04 { grid-column: 5; grid-row: 3; }
        #char05 { grid-column: 5; grid-row: 4; }

        /* Left side - char06, char07, char08 (top to bottom) */
        #char06 { grid-column: 1; grid-row: 2; }
        #char07 { grid-column: 1; grid-row: 3; }
        #char08 { grid-column: 1; grid-row: 4; }

        /* Bottom side - char09, char10, char11 (left to right) */
        #char09 { grid-column: 2; grid-row: 5; }
        #char10 { grid-column: 3; grid-row: 5; }
        #char11 { grid-column: 4; grid-row: 5; }

        .side-input {
            display: flex;
            flex-direction: column;
        }

        .side-input label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .side-input input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            text-transform: uppercase;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .solutions {
            margin-top: 20px;
        }
        
        .solution {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .solution-words {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        
        .solution-score {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .example {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .example h3 {
            margin-top: 0;
            color: #0066cc;
        }
        
        .timing {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Letter Boxed Solver</h1>
    <p>Enter the letters for each side of the Letter Boxed puzzle. The solver will find word combinations that use all letters.</p>
    
    <div class="example">
        <button id="loadTodayBtn" onclick="loadTodaysPuzzle()" style="width: 100%; margin-top: 10px;">
            Load Today's NYT Puzzle
        </button>
        <div class="side-input">
            <label for="examplePuzzle">Or try one of these example puzzles:</label>
            <select id="examplePuzzle" onchange="loadExample()" style="padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 10px;">
                <option value="JGH,NVY,EID,ORP">JGH / NVY / EID / ORP</option>
                <option value="YFA,OTK,LGW,RNI">YFA / OTK / LGW / RNI</option>
                <option value="LHM,CIB,ANK,OUP">LHM / CIB / ANK / OUP</option>
                <option value="GIY,ERC,XHA,LOP">GIY / ERC / XHA / LOP</option>
                <option value="PRC,YAN,LKH,SIO">PRC / YAN / LKH / SIO</option>
                <option value="VYQ,FIG,OTE,XLU">VYQ / FIG / OTE / XLU</option>
            </select>
        </div>
    </div>

    <div class="container">
        <h2>Enter Puzzle</h2>
        <div class="game-input">
            <div class="letter-box-container">
                <!-- Top side: char00, char01, char02 (left to right) -->
                <input type="text" id="char00" class="letter-field" maxlength="1">
                <input type="text" id="char01" class="letter-field" maxlength="1">
                <input type="text" id="char02" class="letter-field" maxlength="1">

                <!-- Right side: char03, char04, char05 (top to bottom) -->
                <input type="text" id="char03" class="letter-field" maxlength="1">
                <input type="text" id="char04" class="letter-field" maxlength="1">
                <input type="text" id="char05" class="letter-field" maxlength="1">

                <!-- Left side: char06, char07, char08 (top to bottom) -->
                <input type="text" id="char06" class="letter-field" maxlength="1">
                <input type="text" id="char07" class="letter-field" maxlength="1">
                <input type="text" id="char08" class="letter-field" maxlength="1">

                <!-- Bottom side: char09, char10, char11 (left to right) -->
                <input type="text" id="char09" class="letter-field" maxlength="1">
                <input type="text" id="char10" class="letter-field" maxlength="1">
                <input type="text" id="char11" class="letter-field" maxlength="1">
            </div>
        </div>

        <div class="side-input" style="margin-top: 20px;">
            <label for="maxSolutions">Max Solutions:</label>
            <input type="number" id="maxSolutions" value="500" min="1" max="65535" style="padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px;">
        </div>

        <button id="solveBtn" onclick="solvePuzzle()">Solve Puzzle</button>
    </div>

    <div class="container" id="results" style="display: none;">
        <h2>Solutions</h2>
        <div id="solutionsList"></div>
    </div>

    <script type="module">
        import init, { solve_game, initialize_dictionary } from './pkg/boxchar.js';
        
        let wasm = null;
        let dictionaryInitialized = false;

        const SIDE_FIELDS = [
            ['char00', 'char01', 'char02'], // side1
            ['char03', 'char04', 'char05'], // side2
            ['char06', 'char07', 'char08'], // side3
            ['char09', 'char10', 'char11']  // side4
        ]

        async function loadAndInitializeDictionary() {
            try {
                const response = await fetch('./dictionary.txt');
                const arrayBuffer = await response.arrayBuffer();
                const dictionaryData = new Uint8Array(arrayBuffer);

                console.log(`Loaded dictionary data: ${dictionaryData.length} bytes`);

                // Initialize the dictionary in WASM
                await initialize_dictionary(dictionaryData);
                dictionaryInitialized = true;

                console.log('Dictionary initialized in WASM');
                return true;
            } catch (error) {
                console.error('Failed to load and initialize dictionary:', error);
                throw new Error('Failed to initialize dictionary: ' + error.message);
            }
        }
        
        async function run() {
            try {
                // Load WASM and initialize dictionary in parallel
                const [wasmModule] = await Promise.all([
                    init(),
                    loadAndInitializeDictionary()
                ]);

                wasm = wasmModule;
                console.log('WASM module loaded and dictionary initialized');

                // Enable the solve button once everything is loaded
                document.getElementById('solveBtn').disabled = false;
                document.getElementById('solveBtn').textContent = 'Solve Puzzle';
            } catch (error) {
                console.error('Initialization failed:', error);
                showError('Failed to initialize solver: ' + error.message);
            }
        }
        
        function getSidesFromFields() { 
            // Gather letters from individual fields into sides array
            return SIDE_FIELDS.map(fieldIds => 
                fieldIds.map(
                    id => document.getElementById(id).value
                ).join('')
            );
        }
            
        
        function savePuzzleToStorage() {
            const puzzle = {
                sides: getSidesFromFields(),
                maxSolutions: document.getElementById('maxSolutions').value
            };
            localStorage.setItem('letterBoxedPuzzle', JSON.stringify(puzzle));
        }

        function loadPuzzleFromStorage() {
            try {
                const saved = localStorage.getItem('letterBoxedPuzzle');
                if (saved) {
                    const puzzle = JSON.parse(saved);
                    window.createBoard(puzzle.sides ?? ['','','','']);
                    document.getElementById('maxSolutions').value = puzzle.maxSolutions || '500';
                }
            } catch (error) {
                console.warn('Failed to load saved puzzle:', error);
            }
        }
        
        function setupInputListeners() {
            // Save to localStorage whenever input changes
            const letterFields = [];
            for (let i = 0; i < 12; i++) {
                const id = `char${i.toString().padStart(2, '0')}`;
                letterFields.push(id);
            }

            letterFields.forEach((id, index) => {
                const field = document.getElementById(id);

                field.addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase();

                    // Only allow single uppercase letter
                    if (value.length > 0) {
                        e.target.value = value[value.length - 1].replace(/[^A-Z]/g, '');

                        // Auto-advance to next field if we typed a letter
                        if (e.target.value && index < letterFields.length - 1) {
                            const nextField = document.getElementById(letterFields[index + 1]);
                            nextField.focus();
                            nextField.select();
                        }
                    }

                    savePuzzleToStorage();
                });

                field.addEventListener('keydown', (e) => {
                    // Handle backspace to go to previous field
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        e.preventDefault();
                        const prevField = document.getElementById(letterFields[index - 1]);
                        prevField.focus();
                        prevField.select();
                    }
                });

                field.addEventListener('click', (e) => {
                    // Select all text when clicking on a field
                    e.target.select();
                });

                field.addEventListener('focus', (e) => {
                    // Select all text when focusing on a field
                    e.target.select();
                });
            });

            document.getElementById('maxSolutions').addEventListener('input', savePuzzleToStorage);
        }
        
        window.loadExample = function() {
            const puzzleSelect = document.getElementById('examplePuzzle');
            const puzzleValue = puzzleSelect.value;
            const sides = puzzleValue.split(',');

            window.createBoard(sides);
        }

        window.createBoard = function(sidesData) {
            if (!Array.isArray(sidesData) || sidesData.length !== 4 || !sidesData.every(s => typeof s === 'string')) {
                alert('Invalid puzzle data format. Expected an array of 4 strings.');
                return;
            }

            // Populate individual character fields from sides data
            // Side 1 (top): char00, char01, char02
            for (let i = 0; i <= 3; i++) {
                const chars = sidesData[i].split('');
                SIDE_FIELDS[i].forEach((id, c) => {
                    document.getElementById(id).value = (chars[c] || '').toUpperCase();
                });
            }

            savePuzzleToStorage();
        }

        window.loadTodaysPuzzle = async function() {
            const btn = document.getElementById('loadTodayBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Loading...';
            btn.disabled = true;

            try {
                const url = 'https://www.nytimes.com/puzzles/letter-boxed';
                let response;

                // Try direct fetch first (works on deployed HTTPS sites)
                try {
                    response = await fetch(url);
                } catch (e) {
                    // Fall back to CORS proxy for localhost
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                    response = await fetch(proxyUrl);
                }

                const html = await response.text();

                const regex = /window\.gameData.*?"sides"\s*:\s*(\[.*?\])/;
                const match = html.match(regex);

                if (!match) {
                    alert('Failed to find puzzle data on the NYT page. The page format may have changed.');
                    return;
                }

                const sidesData = JSON.parse(match[1]);
                window.createBoard(sidesData);
            } catch (error) {
                alert('Failed to load today\'s puzzle: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        window.solvePuzzle = function() {
            if (!wasm || !dictionaryInitialized) {
                showError('Solver not ready yet. Please wait and try again.');
                return;
            }

            const [side1, side2, side3, side4] = getSidesFromFields().map(s => s.toUpperCase().trim());
            const maxSolutionsInput = document.getElementById('maxSolutions').value;
            const maxSolutions = parseInt(maxSolutionsInput) || 500;

            if (!side1 || !side2 || !side3 || !side4) {
                showError('Please fill in all four sides of the puzzle.');
                return;
            }

            if (maxSolutions < 1 || maxSolutions > 65535) {
                showError('Max solutions must be between 1 and 65535.');
                return;
            }

            const sides = [side1, side2, side3, side4].map(s => s.toLowerCase());

            // Show loading state
            const solveBtn = document.getElementById('solveBtn');
            const originalText = solveBtn.textContent;
            solveBtn.textContent = 'Solving...';
            solveBtn.disabled = true;

            const resultsDiv = document.getElementById('results');
            const solutionsList = document.getElementById('solutionsList');

            solutionsList.innerHTML = '<div class="loading">Searching for solutions...</div>';
            resultsDiv.style.display = 'block';

            // Use setTimeout to allow the UI to update before the blocking call
            setTimeout(() => {
                try {
                    // Start timer
                    const startTime = performance.now();

                    // Call the synchronous WASM function using the pre-initialized dictionary
                    const solutions = solve_game(sides, maxSolutions);

                    // Calculate elapsed time
                    const endTime = performance.now();
                    const elapsedMs = Math.round(endTime - startTime);

                    // Display results
                    const startDisplayTime = performance.now();
                    displaySolutions(solutions, elapsedMs);
                    const endDisplayTime = performance.now();

                    const elapsedDisplayMs = Math.round(endDisplayTime - startDisplayTime);
                    console.log(`Displayed solutions in ${elapsedDisplayMs}ms`);
                } catch (error) {
                    showError('Error solving puzzle: ' + error.message);
                    resultsDiv.style.display = 'none';
                } finally {
                    // Reset button state
                    solveBtn.textContent = originalText;
                    solveBtn.disabled = false;
                }
            }, 10); // Small delay to allow UI update
        }
        
        function displaySolutions(solutions, elapsedMs = null) {
            const solutionsList = document.getElementById('solutionsList');
            
            if (solutions.length === 0) {
                solutionsList.innerHTML = '<div class="error">No solutions found. Try a different puzzle or check your input.</div>';
                return;
            }
            
            // Check if first solution is an error message
            if (solutions[0].startsWith('Error:')) {
                solutionsList.innerHTML = `<div class="error">${solutions[0]}</div>`;
                return;
            }
            
            let html = `<p>Found ${solutions.length} solution${solutions.length === 1 ? '' : 's'}`;
            if (elapsedMs !== null) {
                html += ` in <span class="timing">${elapsedMs}ms</span>`;
            }
            html += `:</p>`;
            
            solutions.forEach((solution, index) => {
                const wordCount = solution.split('-').length;
                html += `
                    <div class="solution">
                        <div class="solution-words">${solution}</div>
                        <div class="solution-score">${wordCount} word${wordCount === 1 ? '' : 's'}</div>
                    </div>
                `;
            });
            
            solutionsList.innerHTML = html;
        }
        
        function showError(message) {
            const solutionsList = document.getElementById('solutionsList');
            const resultsDiv = document.getElementById('results');
            
            solutionsList.innerHTML = `<div class="error">${message}</div>`;
            resultsDiv.style.display = 'block';
        }
        
        // Initialize everything when page loads
        async function initialize() {
            // Load saved puzzle from localStorage
            loadPuzzleFromStorage();
            
            // Set up input listeners to save changes
            setupInputListeners();
            
            // Disable solve button initially until WASM and wordlist load
            document.getElementById('solveBtn').disabled = true;
            document.getElementById('solveBtn').textContent = 'Loading...';
            
            // Initialize WASM
            await run();
        }
        
        // Start initialization
        initialize();
    </script>
</body>
</html>