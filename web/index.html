<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Letter Boxed Solver</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .game-input {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .side-input {
            display: flex;
            flex-direction: column;
        }
        
        .side-input label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .side-input input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            text-transform: uppercase;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .solutions {
            margin-top: 20px;
        }
        
        .solution {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .solution-words {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        
        .solution-score {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .example {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .example h3 {
            margin-top: 0;
            color: #0066cc;
        }
        
        .timing {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Letter Boxed Solver</h1>
    <p>Enter the letters for each side of the Letter Boxed puzzle. The solver will find word combinations that use all letters.</p>
    
    <div class="example">
        <h3>Example Puzzles</h3>
        <p>Try one of these example puzzles:</p>
        <div class="side-input">
            <label for="examplePuzzle">Select Example:</label>
            <select id="examplePuzzle" onchange="loadExample()" style="padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 10px;">
                <option value="JGH,NVY,EID,ORP">JGH / NVY / EID / ORP</option>
                <option value="YFA,OTK,LGW,RNI">YFA / OTK / LGW / RNI</option>
                <option value="LHM,CIB,ANK,OUP">LHM / CIB / ANK / OUP</option>
                <option value="GIY,ERC,XHA,LOP">GIY / ERC / XHA / LOP</option>
                <option value="PRC,YAN,LKH,SIO">PRC / YAN / LKH / SIO</option>
            </select>
        </div>
    </div>

    <div class="container">
        <h2>Enter Puzzle</h2>
        <div class="game-input">
            <div class="side-input">
                <label for="side1">Side 1:</label>
                <input type="text" id="side1" placeholder="e.g., JGH" maxlength="10">
            </div>
            <div class="side-input">
                <label for="side2">Side 2:</label>
                <input type="text" id="side2" placeholder="e.g., NVY" maxlength="10">
            </div>
            <div class="side-input">
                <label for="side3">Side 3:</label>
                <input type="text" id="side3" placeholder="e.g., EID" maxlength="10">
            </div>
            <div class="side-input">
                <label for="side4">Side 4:</label>
                <input type="text" id="side4" placeholder="e.g., ORP" maxlength="10">
            </div>
        </div>

        <div class="side-input" style="margin-top: 20px;">
            <label for="maxSolutions">Max Solutions:</label>
            <input type="number" id="maxSolutions" value="500" min="1" max="65535" style="padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px;">
        </div>

        <button id="solveBtn" onclick="solvePuzzle()">Solve Puzzle</button>
    </div>

    <div class="container" id="results" style="display: none;">
        <h2>Solutions</h2>
        <div id="solutionsList"></div>
    </div>

    <script type="module">
        import init, { solve_game, initialize_dictionary } from './pkg/boxchar.js';
        
        let wasm = null;
        let dictionaryInitialized = false;

        async function loadAndInitializeDictionary() {
            try {
                const response = await fetch('./dictionary.txt');
                const arrayBuffer = await response.arrayBuffer();
                const dictionaryData = new Uint8Array(arrayBuffer);

                console.log(`Loaded dictionary data: ${dictionaryData.length} bytes`);

                // Initialize the dictionary in WASM
                await initialize_dictionary(dictionaryData);
                dictionaryInitialized = true;

                console.log('Dictionary initialized in WASM');
                return true;
            } catch (error) {
                console.error('Failed to load and initialize dictionary:', error);
                throw new Error('Failed to initialize dictionary: ' + error.message);
            }
        }
        
        async function run() {
            try {
                // Load WASM and initialize dictionary in parallel
                const [wasmModule] = await Promise.all([
                    init(),
                    loadAndInitializeDictionary()
                ]);

                wasm = wasmModule;
                console.log('WASM module loaded and dictionary initialized');

                // Enable the solve button once everything is loaded
                document.getElementById('solveBtn').disabled = false;
                document.getElementById('solveBtn').textContent = 'Solve Puzzle';
            } catch (error) {
                console.error('Initialization failed:', error);
                showError('Failed to initialize solver: ' + error.message);
            }
        }
        
        function savePuzzleToStorage() {
            const puzzle = {
                side1: document.getElementById('side1').value,
                side2: document.getElementById('side2').value,
                side3: document.getElementById('side3').value,
                side4: document.getElementById('side4').value,
                maxSolutions: document.getElementById('maxSolutions').value
            };
            localStorage.setItem('letterBoxedPuzzle', JSON.stringify(puzzle));
        }
        
        function loadPuzzleFromStorage() {
            try {
                const saved = localStorage.getItem('letterBoxedPuzzle');
                if (saved) {
                    const puzzle = JSON.parse(saved);
                    document.getElementById('side1').value = puzzle.side1 || '';
                    document.getElementById('side2').value = puzzle.side2 || '';
                    document.getElementById('side3').value = puzzle.side3 || '';
                    document.getElementById('side4').value = puzzle.side4 || '';
                    document.getElementById('maxSolutions').value = puzzle.maxSolutions || '500';
                }
            } catch (error) {
                console.warn('Failed to load saved puzzle:', error);
            }
        }
        
        function setupInputListeners() {
            // Save to localStorage whenever input changes
            ['side1', 'side2', 'side3', 'side4', 'maxSolutions'].forEach(id => {
                document.getElementById(id).addEventListener('input', savePuzzleToStorage);
            });
        }
        
        window.loadExample = function() {
            const puzzleSelect = document.getElementById('examplePuzzle');
            const puzzleValue = puzzleSelect.value;
            const sides = puzzleValue.split(',');

            document.getElementById('side1').value = sides[0];
            document.getElementById('side2').value = sides[1];
            document.getElementById('side3').value = sides[2];
            document.getElementById('side4').value = sides[3];
            // Save the example to localStorage
            savePuzzleToStorage();
        }
        
        window.solvePuzzle = function() {
            if (!wasm || !dictionaryInitialized) {
                showError('Solver not ready yet. Please wait and try again.');
                return;
            }

            const side1 = document.getElementById('side1').value.toUpperCase().trim();
            const side2 = document.getElementById('side2').value.toUpperCase().trim();
            const side3 = document.getElementById('side3').value.toUpperCase().trim();
            const side4 = document.getElementById('side4').value.toUpperCase().trim();
            const maxSolutionsInput = document.getElementById('maxSolutions').value;
            const maxSolutions = parseInt(maxSolutionsInput) || 500;

            if (!side1 || !side2 || !side3 || !side4) {
                showError('Please fill in all four sides of the puzzle.');
                return;
            }

            if (maxSolutions < 1 || maxSolutions > 65535) {
                showError('Max solutions must be between 1 and 65535.');
                return;
            }

            const sides = [side1, side2, side3, side4].map(s => s.toLowerCase());

            // Show loading state
            const solveBtn = document.getElementById('solveBtn');
            const originalText = solveBtn.textContent;
            solveBtn.textContent = 'Solving...';
            solveBtn.disabled = true;

            const resultsDiv = document.getElementById('results');
            const solutionsList = document.getElementById('solutionsList');

            solutionsList.innerHTML = '<div class="loading">Searching for solutions...</div>';
            resultsDiv.style.display = 'block';

            // Use setTimeout to allow the UI to update before the blocking call
            setTimeout(() => {
                try {
                    // Start timer
                    const startTime = performance.now();

                    // Call the synchronous WASM function using the pre-initialized dictionary
                    const solutions = solve_game(sides, maxSolutions);

                    // Calculate elapsed time
                    const endTime = performance.now();
                    const elapsedMs = Math.round(endTime - startTime);

                    // Display results
                    const startDisplayTime = performance.now();
                    displaySolutions(solutions, elapsedMs);
                    const endDisplayTime = performance.now();

                    const elapsedDisplayMs = Math.round(endDisplayTime - startDisplayTime);
                    console.log(`Displayed solutions in ${elapsedDisplayMs}ms`);
                } catch (error) {
                    showError('Error solving puzzle: ' + error.message);
                    resultsDiv.style.display = 'none';
                } finally {
                    // Reset button state
                    solveBtn.textContent = originalText;
                    solveBtn.disabled = false;
                }
            }, 10); // Small delay to allow UI update
        }
        
        function displaySolutions(solutions, elapsedMs = null) {
            const solutionsList = document.getElementById('solutionsList');
            
            if (solutions.length === 0) {
                solutionsList.innerHTML = '<div class="error">No solutions found. Try a different puzzle or check your input.</div>';
                return;
            }
            
            // Check if first solution is an error message
            if (solutions[0].startsWith('Error:')) {
                solutionsList.innerHTML = `<div class="error">${solutions[0]}</div>`;
                return;
            }
            
            let html = `<p>Found ${solutions.length} solution${solutions.length === 1 ? '' : 's'}`;
            if (elapsedMs !== null) {
                html += ` in <span class="timing">${elapsedMs}ms</span>`;
            }
            html += `:</p>`;
            
            solutions.forEach((solution, index) => {
                const wordCount = solution.split('-').length;
                html += `
                    <div class="solution">
                        <div class="solution-words">${solution}</div>
                        <div class="solution-score">${wordCount} word${wordCount === 1 ? '' : 's'}</div>
                    </div>
                `;
            });
            
            solutionsList.innerHTML = html;
        }
        
        function showError(message) {
            const solutionsList = document.getElementById('solutionsList');
            const resultsDiv = document.getElementById('results');
            
            solutionsList.innerHTML = `<div class="error">${message}</div>`;
            resultsDiv.style.display = 'block';
        }
        
        // Initialize everything when page loads
        async function initialize() {
            // Load saved puzzle from localStorage
            loadPuzzleFromStorage();
            
            // Set up input listeners to save changes
            setupInputListeners();
            
            // Disable solve button initially until WASM and wordlist load
            document.getElementById('solveBtn').disabled = true;
            document.getElementById('solveBtn').textContent = 'Loading...';
            
            // Initialize WASM
            await run();
        }
        
        // Start initialization
        initialize();
    </script>
</body>
</html>